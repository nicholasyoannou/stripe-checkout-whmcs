<h1 align="center">
Stripe Checkout for WHMCS
</h1>
<p align="center">
A simple Stripe Checkout for WHMCS using FastAPI, and simple WHMCS forwarding logic.
</p>

## Information
Stripe's checkout system allows use of their fraud protection system (if the Stripe account is eligible) allowing, if a customer chargebacks, no chargeback fees up to $25,000 (as far as I'm aware). To be eligible for Stripe's Chargeback Protection Program, payments need to be processed through Stripe's Checkout page infrastructure, hence this plugin.

### Known issues, and contributional info
There are known issues as of writing:
- Purchases from the same email will, under the Stripe panel, for some reason treat it as a different customer (will create a new customer) and the transactions by them won't appear under the same user - but all transactions made by them can be filtered by e-mail as enforcement of the WHMCS billing email is enforced.
- (Not a bug but improvement) After checkout it redirects back to FastAPI, but I'd like to scrap FastAPI entirely in the future, or slowly slowly move over to PHP. Due to my inexperience I've coded it with assistance of the WHMCS docs and done with what I know.

Contributions would much be appreciated; would like this to be a community effort as I feel this code (at the moment) is leaning towards the low-effort side of some un-noticable bugs, and efficiency-side can be a lot better with it being done fully in PHP, WHMCS handling everything without the need of FastAPI and Redis.

## How this plugin works
Quite simply, on checkout (via WHMCS) as soon as the user submits to pay:
- the user email, invoice number, and amount is submitted (POST) via form data to FastAPI
- request is processed and a series of checks is conducted to check that the purchase is valid
- if checks are correct, a Stripe Checkout payment URL is generated by making a POST request to Stripes API using the Stripe account secret key
- Redis then (temporarily) stores a link between the Stripe Checkout URL, and the WHMCS invoice ID which is involved in later checks (expires (to account for machine storage) slightly longer than 30 mins to account for 3D Secure and other scenarios)
- FastAPI redirects the user to the Stripe Checkout payment page, where the user pays (user has 30 mins to pay otherwise link expires)
- If the user fails payment via the checkout, or hits the back button (on Stripe Checkout page), the user will be displayed with a failed message on the WHMCS invoice page. The user has 30 minutes to hit the pay button again to pay for it (as Redis is still storing the link between the two) otherwise the link will expire. Hitting 'pay' after that time will generate a new Stripe Checkout link.
- After payment, the user is redirected back to the FastAPI (via a GET request) site which directly checks if the invoice has been paid via Stripe, and the invoice has been paid within the last 30 minutes
- if the invoice has been paid, a payment will be added to the invoice with the transaction ID of the Stripe invoice
- the user is redirected back to the invoice page with a 'payment successful' message

## Installation and setup
### Prerequisites
This following is required:
- WHMCS installation with administrator access (in order to create API credentials)
- A VPS/instance able to host a Python3 program of FastAPI, which is publicly exposable (does not matter on port but ports 443/80 recommended)
- A Redis instance (can be self-hosted (for best security and performance, on same instance as FastAPI) or using free services like [Upstash](https://upstash.com/))

Optional prerequisites:
- NGINX/Apache, if on VPS/dedicated, to reverse proxy FastAPI

### FastAPI install
1. Download the `api` folder to the computer which is going to host the FastAPI program. `pip install -r requirements.txt` to install dependencies.
2. Edit the environment variables file (.env file), if you haven't already.
3. Launch server.py in the background (however you normally), I personally use PM2 (`pm2 start server.py --name FastAPI --interpreter python3` - see PM2 docs for more info on how to use it)
4. (Optional, but recommended) Reverse proxy FastAPI under NGINX/Apache (or whatever web server you usually use), using the billing URL you specified in the environment variables file.

### WHMCS install
1. Download the file in the WHMCS folder in the GitHub repository, and near the bottom of the file, replace "INSERT_YOUR_API_URL_HERE_INCLUDING_HTTPS_OR_HTTP_PART" with your FastAPI billing hostname including https/http part, e.g. https://stripeworker.bobsbakery.tld.
2. Upload the file in the WHMCS directory, ./modules/gateways

## License
When used, please credit me somewhere. It can be used for non-profit, commercial use, whatever, as long as this is the case. Even if you fork this code, and make it completely different, just pop my name in the credits would be much appreciated :)
